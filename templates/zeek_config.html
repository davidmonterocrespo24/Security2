{% extends "base.html" %}
{% block title %}Configuración de Zeek{% endblock %}
{% block header %}Configuración de Zeek{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- Control del Servicio -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4"><i class="fas fa-power-off mr-2 text-blue-600"></i> Control del Servicio</h3>
        <div id="service-status" class="mb-4 p-4 rounded"></div>
        <div class="flex space-x-4">
            <button onclick="startZeek()" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700"><i class="fas fa-play mr-2"></i> Iniciar</button>
            <button onclick="stopZeek()" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700"><i class="fas fa-stop mr-2"></i> Detener</button>
            <button onclick="restartZeek()" class="px-6 py-2 bg-orange-600 text-white rounded hover:bg-orange-700"><i class="fas fa-redo mr-2"></i> Reiniciar</button>
        </div>
    </div>

    <!-- Configuración de Interfaz -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4"><i class="fas fa-network-wired mr-2 text-purple-600"></i> Interfaz de Red</h3>
        <select id="interface-select" class="w-full px-4 py-2 border rounded mb-4"></select>
        <button onclick="saveInterface()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"><i class="fas fa-save mr-2"></i> Guardar Interfaz</button>
    </div>

    <!-- Auto-Importación de Logs -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4"><i class="fas fa-sync mr-2 text-indigo-600"></i> Auto-Importación de Logs</h3>
        <div class="flex items-center space-x-4">
            <label class="flex items-center">
                <input type="checkbox" id="auto-import-enabled" class="mr-2">
                <span>Activar importación automática</span>
            </label>
            <input type="number" id="auto-import-interval" placeholder="Intervalo (segundos)" value="300" class="px-4 py-2 border rounded w-48">
        </div>
        <button onclick="saveAutoImport()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"><i class="fas fa-save mr-2"></i> Guardar Configuración</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    loadStatus();
    loadInterfaces();
    loadConfig();
});

async function loadStatus() {
    const res = await fetch('/zeek/api/status');
    const data = await res.json();
    const status = document.getElementById('service-status');
    status.innerHTML = data.running ?
        '<div class="bg-green-100 text-green-800 p-4 rounded"><i class="fas fa-check-circle mr-2"></i>Zeek está corriendo</div>' :
        '<div class="bg-red-100 text-red-800 p-4 rounded"><i class="fas fa-times-circle mr-2"></i>Zeek está detenido</div>';
}

async function loadInterfaces() {
    const res = await fetch('/zeek/api/interfaces');
    const data = await res.json();
    const select = document.getElementById('interface-select');
    select.innerHTML = data.interfaces.map(i => `<option value="${i.name}">${i.name} (${i.ip || 'Sin IP'})</option>`).join('');
}

async function loadConfig() {
    const res = await fetch('/zeek/api/config');
    const data = await res.json();
    if (data.success) {
        document.getElementById('auto-import-enabled').checked = data.config.auto_import_enabled || false;
        document.getElementById('auto-import-interval').value = data.config.auto_import_interval || 300;
    }
}

async function startZeek() {
    const iface = document.getElementById('interface-select').value;
    const res = await fetch('/zeek/api/start', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interface: iface})});
    const data = await res.json();
    showNotification(data.message, data.success ? 'success' : 'error');
    loadStatus();
}

async function stopZeek() {
    const res = await fetch('/zeek/api/stop', {method: 'POST'});
    const data = await res.json();
    showNotification(data.message, data.success ? 'success' : 'error');
    loadStatus();
}

async function restartZeek() {
    const res = await fetch('/zeek/api/restart', {method: 'POST'});
    const data = await res.json();
    showNotification(data.message, data.success ? 'success' : 'error');
    loadStatus();
}

async function saveInterface() {
    const iface = document.getElementById('interface-select').value;
    const res = await fetch('/zeek/api/config', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({interface: iface})});
    const data = await res.json();
    showNotification(data.message || 'Interfaz guardada', data.success ? 'success' : 'error');
}

async function saveAutoImport() {
    const enabled = document.getElementById('auto-import-enabled').checked;
    const interval = parseInt(document.getElementById('auto-import-interval').value);
    const res = await fetch('/zeek/api/config', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({options: {auto_import_enabled: enabled, auto_import_interval: interval}})});
    const data = await res.json();
    showNotification('Configuración guardada', data.success ? 'success' : 'error');
}
</script>
{% endblock %}
