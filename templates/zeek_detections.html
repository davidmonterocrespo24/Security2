{% extends "base.html" %}
{% block title %}Detecciones Avanzadas de Zeek{% endblock %}
{% block header %}Detecciones Avanzadas con Zeek{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Port Scans -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold"><i class="fas fa-radar text-red-600 mr-2"></i> Port Scans Detectados</h3>
            <button onclick="loadPortScans()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"><i class="fas fa-sync mr-2"></i> Actualizar</button>
        </div>
        <div id="port-scans" class="space-y-2"></div>
    </div>

    <!-- DNS Analysis -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold"><i class="fas fa-biohazard text-orange-600 mr-2"></i> DGA Detectado</h3>
                <button onclick="loadDNSAnalysis()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"><i class="fas fa-sync mr-1"></i></button>
            </div>
            <div id="dga-list" class="space-y-2"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold"><i class="fas fa-tunnel text-purple-600 mr-2"></i> DNS Tunneling</h3>
                <button onclick="loadDNSAnalysis()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"><i class="fas fa-sync mr-1"></i></button>
            </div>
            <div id="tunneling-list" class="space-y-2"></div>
        </div>
    </div>

    <!-- SSL Analysis -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-sm font-semibold mb-4"><i class="fas fa-certificate text-red-600 mr-2"></i> Certificados Auto-firmados</h3>
            <div id="self-signed-list" class="space-y-2"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-sm font-semibold mb-4"><i class="fas fa-clock text-orange-600 mr-2"></i> Certificados Expirados</h3>
            <div id="expired-list" class="space-y-2"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-sm font-semibold mb-4"><i class="fas fa-key text-yellow-600 mr-2"></i> Ciphers Débiles</h3>
            <div id="weak-cipher-list" class="space-y-2"></div>
        </div>
    </div>

    <!-- Beaconing -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold"><i class="fas fa-satellite-dish text-indigo-600 mr-2"></i> Beaconing (C&C) Detectado</h3>
            <button onclick="loadBeaconing()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"><i class="fas fa-sync mr-2"></i> Actualizar</button>
        </div>
        <div id="beaconing-list" class="space-y-2"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    loadPortScans();
    loadDNSAnalysis();
    loadSSLAnalysis();
    loadBeaconing();
});

async function loadPortScans() {
    const res = await fetch('/zeek/api/detections/port-scans?hours_back=24&min_ports=15');
    const data = await res.json();
    const container = document.getElementById('port-scans');

    if (data.success && data.port_scanners.length > 0) {
        container.innerHTML = data.port_scanners.map(s => `
            <div class="p-4 border-l-4 ${s.severity === 'critical' ? 'border-red-600 bg-red-50' : s.severity === 'high' ? 'border-orange-600 bg-orange-50' : 'border-yellow-600 bg-yellow-50'} rounded">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold text-gray-800">${s.ip}</p>
                        <p class="text-sm text-gray-600">${s.ports_scanned} puertos | ${s.scan_rate} p/s | ${s.time_window}s</p>
                        <p class="text-xs text-gray-500 mt-1">${s.first_seen} → ${s.last_seen}</p>
                    </div>
                    <span class="px-3 py-1 text-sm font-semibold rounded ${s.severity === 'critical' ? 'bg-red-600 text-white' : s.severity === 'high' ? 'bg-orange-600 text-white' : 'bg-yellow-600 text-white'}">${s.severity.toUpperCase()}</span>
                </div>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<p class="text-gray-500 text-sm">No se detectaron port scans</p>';
    }
}

async function loadDNSAnalysis() {
    const res = await fetch('/zeek/api/detections/dns-analysis?hours_back=24');
    const data = await res.json();

    if (data.success) {
        // DGA
        const dgaContainer = document.getElementById('dga-list');
        if (data.analysis.dga_detected.length > 0) {
            dgaContainer.innerHTML = data.analysis.dga_detected.slice(0, 10).map(d => `
                <div class="p-3 bg-orange-50 border-l-4 border-orange-500 rounded">
                    <p class="font-semibold text-sm text-gray-800">${d.domain}</p>
                    <p class="text-xs text-gray-600">IP: ${d.source_ip} | Entropía: ${d.entropy}</p>
                </div>
            `).join('');
        } else {
            dgaContainer.innerHTML = '<p class="text-gray-500 text-sm">No detectado</p>';
        }

        // Tunneling
        const tunnelContainer = document.getElementById('tunneling-list');
        if (data.analysis.tunneling_detected.length > 0) {
            tunnelContainer.innerHTML = data.analysis.tunneling_detected.slice(0, 10).map(t => `
                <div class="p-3 bg-purple-50 border-l-4 border-purple-500 rounded">
                    <p class="font-semibold text-sm text-gray-800 truncate">${t.domain}</p>
                    <p class="text-xs text-gray-600">IP: ${t.source_ip} | ${t.length} chars</p>
                </div>
            `).join('');
        } else {
            tunnelContainer.innerHTML = '<p class="text-gray-500 text-sm">No detectado</p>';
        }
    }
}

async function loadSSLAnalysis() {
    const res = await fetch('/zeek/api/detections/ssl-analysis?hours_back=24');
    const data = await res.json();

    if (data.success) {
        // Self-signed
        const selfSigned = document.getElementById('self-signed-list');
        if (data.analysis.self_signed_certs.length > 0) {
            selfSigned.innerHTML = data.analysis.self_signed_certs.slice(0, 5).map(c => `
                <div class="p-2 bg-red-50 rounded text-sm">
                    <p class="font-semibold">${c.server_name || c.dest_ip}</p>
                    <p class="text-xs text-gray-600">${c.source_ip}</p>
                </div>
            `).join('');
        } else {
            selfSigned.innerHTML = '<p class="text-gray-500 text-xs">Ninguno</p>';
        }

        // Expired
        const expired = document.getElementById('expired-list');
        if (data.analysis.expired_certs.length > 0) {
            expired.innerHTML = data.analysis.expired_certs.slice(0, 5).map(c => `
                <div class="p-2 bg-orange-50 rounded text-sm">
                    <p class="font-semibold">${c.server_name || c.dest_ip}</p>
                    <p class="text-xs text-gray-600">${c.source_ip}</p>
                </div>
            `).join('');
        } else {
            expired.innerHTML = '<p class="text-gray-500 text-xs">Ninguno</p>';
        }

        // Weak ciphers
        const weak = document.getElementById('weak-cipher-list');
        if (data.analysis.weak_ciphers.length > 0) {
            weak.innerHTML = data.analysis.weak_ciphers.slice(0, 5).map(c => `
                <div class="p-2 bg-yellow-50 rounded text-sm">
                    <p class="font-semibold">${c.server_name || c.dest_ip}</p>
                    <p class="text-xs text-gray-600">${c.version}</p>
                </div>
            `).join('');
        } else {
            weak.innerHTML = '<p class="text-gray-500 text-xs">Ninguno</p>';
        }
    }
}

async function loadBeaconing() {
    const res = await fetch('/zeek/api/detections/beaconing?hours_back=24&threshold=0.9');
    const data = await res.json();
    const container = document.getElementById('beaconing-list');

    if (data.success && data.beaconing_suspects.length > 0) {
        container.innerHTML = data.beaconing_suspects.map(b => `
            <div class="p-4 bg-indigo-50 border-l-4 border-indigo-600 rounded">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold text-gray-800">${b.source_ip} → ${b.dest_ip}:${b.dest_port}</p>
                        <p class="text-sm text-gray-600">${b.connection_count} conexiones | Intervalo: ${b.mean_interval}s</p>
                        <p class="text-xs text-gray-500 mt-1">${b.first_seen} → ${b.last_seen}</p>
                    </div>
                    <span class="px-3 py-1 text-sm font-semibold bg-indigo-600 text-white rounded">${(b.regularity * 100).toFixed(0)}% regular</span>
                </div>
            </div>
        `).join('');
    } else {
        container.innerHTML = '<p class="text-gray-500 text-sm">No se detectó beaconing</p>';
    }
}
</script>
{% endblock %}
